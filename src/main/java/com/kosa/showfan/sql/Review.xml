<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kosa.showfan.review.ReviewMapper">
	<resultMap type="ReviewDTO" id="ReviewMap" autoMapping="true">
		<id column="review_id" property="reviewId" />
		<collection property="reviewReply" ofType="ReplyDTO"
			autoMapping="true">
		</collection>
	</resultMap>
	<select id="selectByShowId" parameterType="int"
		resultMap="ReviewMap">
	SELECT
		r.REVIEW_ID,
		r.MEMBER_ID,
		r.REVIEW_GRADE,
		r.REVIEW_CONTENT,
		r.REPLY_CREATED_AT,
		r.REVIEW_IS_MODIFIED,
		r.SEAT_ID,
		rep.reply_ID,
		rep.REPLY_CONTENT,
		rep.MEMBER_ID,
		rep.REPLY_CREATED_AT
	FROM review r JOIN
		reply rep ON (r.REVIEW_ID = rep.REVIEW_ID)
	WHERE r.SHOW_ID = #{showId};
	</select>
	<insert id="insertReview" parameterType="ReviewDTO">
		INSERT INTO
		review(review_id, member_id, show_id, review_grade, review_content, REVIEW_IS_MODIFIED, REVIEW_CREATED_AT) 
		VALUES (review_seq, #{memberId}, #{showId}, #{reviewGrade}, #{reviewContent}, '0', sysdate)
	</insert>
	<!-- 수정됨 추가, 작성시간은 최초 작성시간 -->
	<update id="updateReview" parameterType="ReviewDTO">
		UPDATE review 
		SET review_content = #{reviewContent}, REVIEW_IS_MODIFIED='1'
		WHERE review_id = #{reviewId}
	</update>
	<!-- 테이블에서 cascasde 이용해서 리뷰 삭제시 답글도  삭제  -->
	<delete id="deleteReview" parameterType="ReviewDTO">
		DELETE FROM review 
		WHERE review_id = #{reviewId}
	</delete>
</mapper>